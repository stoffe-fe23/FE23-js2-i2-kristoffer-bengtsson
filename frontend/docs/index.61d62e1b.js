class e{#e;#t;constructor(e,t=""){this.#e=e,this.#t=t}get baseUrl(){return this.#e}async getJson(e="",t=null){let s=await fetch(this.#s(e,t)),r=await s.json();return s.ok||this.#r(s,r),r}async postJson(e="",t=null,s=null){let r=await fetch(this.#s(e,s),this.#a("POST",t??{})),a=await r.json();return r.ok||this.#r(r,a),a}async updateJson(e="",t=null,s=null){let r=await fetch(this.#s(e,s),this.#a("PATCH",t??{})),a=await r.json();return r.ok||this.#r(r,a),a}async deleteJson(e="",t=null,s=null){let r=await fetch(this.#s(e,s),this.#a("DELETE",t??{})),a=await r.json();return r.ok||this.#r(r,a),a}formdataToJson(e){var t={};return e instanceof FormData&&e.forEach((e,s)=>{let r=isNaN(e)?e:parseInt(e);r="true"===r||"false"!==r&&r,s in t?(Array.isArray(t[s])||(t[s]=[t[s]]),t[s].push(r)):t[s]=r}),JSON.stringify(t)}#r(e,s){if(400==e.status){if(s.error&&s.data&&"Validation error"==s.error){if(Array.isArray(s.data)){let r="<ul>";if(s.data.length)for(let e of s.data)r+=`<li>${e.msg??"No message"}</li>`;else r+=`<li>${s.error}</li>`;throw r+="</ul>",new t(e.status,r)}}else throw new t(e.status,`API Error: ${s.error??""}  (${e.statusText})`)}else if(500==e.status)throw new t(e.status,`API Error: ${s.error??""}  (${e.statusText})`);else throw new t(e.status,`API Error: ${e.statusText}`)}#s(e="",t=null){let s=new URL(`${this.#e}${e.length?"/"+e:""}${this.#t}`);if(t)for(let e in t)s.searchParams.append(e,t[e]);return s}#a(e,t){return{method:e,headers:{"Content-Type":"application/json"},body:t instanceof FormData?this.formdataToJson(t):JSON.stringify(t)}}}class t extends Error{#n;constructor(e,t){super(t),this.#n=e}get errorCode(){return this.#n}}function s(e,t,s=null,n="",o=null,i=!1){var l;let d=document.createElement(e);if(e=e.toLowerCase(),function(e,t=1){return null!=e&&"object"==typeof e&&Object.keys(e).length>=t}(o,1))for(let e in o)d.setAttribute(e,o[e]);if(null!=(l=d)&&n.length>0&&(Array.isArray(n)?l.classList.add(...n):a(n)&&l.classList.add(n)),function(e,t=1){return null!=e&&Array.isArray(e)&&void 0!==e.length&&e.length>=t}(t)){if("ul"==e||"ol"==e)for(let e of t){let t=document.createElement("li");r(t,e,i),d.appendChild(t)}else if("select"==e||"datalist"==e)for(let e of t){let[t,s,a]=e.split("|"),n=document.createElement("option");if(r(n,s??t,i),n.value=t,void 0!==a){let e=d.querySelector(`optgroup[label="${a}"]`);null==e&&((e=document.createElement("optgroup")).label=a,d.appendChild(e)),e.appendChild(n)}else d.appendChild(n)}else r(d,t[0],i)}else if(a(t,1)){if("img"==e)d.alt=t;else if("input"==e&&t.length>0){let e=d,s=document.createElement("label");(d=document.createElement("div")).id=`${e.id}-wrapper`,n.length>0&&d.classList.add((Array.isArray(n)?n[0]:n)+"-wrapper"),s.setAttribute("for",e.id),r(s,t,i),"radio"==e.getAttribute("type")||"checkbox"==e.getAttribute("type")?(s.classList.add("input-box-label"),d.append(e,s)):d.append(s,e)}else r(d,t,i)}return null!=s&&s.appendChild(d),d}function r(e,t,s){s?e.innerHTML=t:e.innerText=t}function a(e,t=1){return null!=e&&void 0!==e.length&&e.length>=t}function n({message:e}){let t=document.querySelector("#errors");t.innerHTML="";let r=s("div","",t,"error-message");s("h2","Error",r),s("div",e,r,"error-box-message",null,!0),s("button","OK",r,"error-close-button").addEventListener("click",e=>{e.currentTarget.closest("dialog").close()}),console.error(e),t.showModal()}function o(e,t,s){let r={"created-time":function(e,t="sv-SE"){let s=new Date(e);return new Intl.DateTimeFormat(t,{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}).format(s)}(e.time),"task-text":e.message,"assigned-to":e.assigned??""},a={"data-taskid":e.taskid,"data-time":e.time},n=function(e,t=null,s={},r=null,a=!1){let n=document.getElementById(e).content.firstElementChild.cloneNode(!0);for(let e in s){let t=n.querySelector(`.${e}`);t&&(t[a?"innerHTML":"innerText"]=s[e])}if(r)for(let e in r){let t=n.querySelector(`[${e}]`);n.getAttribute(e)?n.setAttribute(e,r[e]):t&&t.setAttribute(e,r[e])}return t&&t.appendChild(n),n}(`tpl-task-${e.state}`,t,r,a);if(n.classList.add(`color-${e.category}`),s){let e=n.querySelector("form");e&&e.addEventListener("submit",s)}return n}class i{static validStates=["todo","wip","done"];api;socketClient;#o;constructor(t){this.api=new e(t),this.#i(t)}deleteTask(e){this.api.deleteJson(`delete/${e}`).catch(n)}setTaskDone(e){this.api.updateJson(`done/${e}`).catch(n)}assignTask(e){this.api.updateJson("assign",e).catch(n)}addNewTask(e){this.api.postJson("add",e).catch(n)}showTasks(){this.api.getJson("list").then(e=>{let t={};if(i.validStates.forEach(e=>t[e]=document.querySelector(`#tasks-${e}-box`)),Object.values(t).forEach(e=>{e.innerHTML=""}),e.length)for(let s of(e.sort((e,t)=>e.time-t.time),e))o(s,t[s.state],this.#o)}).catch(n)}setOnAssignTaskEvent(e){"function"==typeof e&&(this.#o=e)}#i(e){let t=new URL(e);this.socketClient=new WebSocket(`ws://${t.hostname}:${t.port}/updates`),this.socketClient.addEventListener("message",this.#l.bind(this)),this.socketClient.addEventListener("close",this.#d.bind(this))}#d(e){setTimeout(this.#c.bind(this),4e3)}#c(){console.log("Reinitializing server connection..."),this.socketClient&&this.socketClient.readyState!=WebSocket.CLOSED&&this.socketClient.readyState!=WebSocket.CLOSING&&this.socketClient.close(),this.socketClient=null,this.#i(this.api.baseUrl)}#l(e){let t=JSON.parse(e.data),s=document.querySelector(`article[data-taskid="${t.data.taskid}"]`);s&&s.remove(),"deleted"!=t.type&&(o(t.data,document.querySelector(`#tasks-${t.data.state}-box`),this.#o),this.#u())}#u(){i.validStates.forEach(e=>{let t=document.querySelector(`#tasks-${e}-box`);for(let e=1;e<t.children.length;e++){let s=t.children[e],r=e-1;for(;r>=0&&t.children[r].dataset.time>s.dataset.time;)t.children[r+1].after(t.children[r]),r--;t.children[r+1].after(s)}})}}let l=0;const d=new i("http://localhost:3000/tasks");function c(e){switch(e.type){case"dragstart":e.target.matches("article")&&(e.target.classList.add("dragged"),e.dataTransfer.setData("text",e.target.getAttribute("data-taskid")),l=0);break;case"dragend":e.target.matches("article")&&e.target.classList.remove("dragged");break;case"dragover":e.preventDefault();break;case"dragenter":u(e.currentTarget,++l);break;case"dragleave":u(e.currentTarget,--l);break;case"drop":let t=e.dataTransfer.getData("text");t&&d.setTaskDone(t),u(e.currentTarget,--l)}}function u(e,t){t&&!e.classList.contains("dragover")?e.classList.add("dragover"):!t&&e.classList.contains("dragover")&&e.classList.remove("dragover")}d.setOnAssignTaskEvent(e=>{e.preventDefault();let t=new FormData(e.currentTarget);t.set("taskid",e.submitter.closest("article").dataset.taskid),d.assignTask(t)}),document.querySelector("#new-task-form").addEventListener("submit",e=>{e.preventDefault();let t=new FormData(e.currentTarget,e.submitter);d.addNewTask(t),e.currentTarget.reset()}),document.querySelector("#tasks-wip-box").addEventListener("submit",e=>{e.preventDefault();let t=e.submitter.closest("article").dataset.taskid;t?d.setTaskDone(t):console.error("Error marking task as done: Task ID not found!")}),document.querySelector("#tasks-done-box").addEventListener("submit",e=>{e.preventDefault();let t=e.submitter.closest("article").dataset.taskid;t?confirm("Are you sure you wish to delete this task?")&&d.deleteTask(t):console.error("Error deleting task: Task ID not found!")}),document.querySelector("#tasks-wip-box").addEventListener("dragstart",c),document.querySelector("#tasks-wip-box").addEventListener("dragend",c),document.querySelector("#tasks-done").addEventListener("dragover",c),document.querySelector("#tasks-done").addEventListener("dragenter",c),document.querySelector("#tasks-done").addEventListener("dragleave",c),document.querySelector("#tasks-done").addEventListener("drop",c),d.showTasks();
//# sourceMappingURL=index.61d62e1b.js.map
